<!DOCTYPE html>
<html id="html">
<title>Test for displayport supression during page load</title>
<meta charset="utf-8">
<script src="apz_test_utils.js"></script>
<script src="/tests/SimpleTest/EventUtils.js"></script>
<script src="/tests/SimpleTest/paint_listener.js"></script>
<style>
iframe {
  width: 500px;
  height: 500px;
  border: none;
}
</style>
<body>
<iframe></iframe>
</body>
<script>
async function test() {
  const readyPromise = new Promise(resolve => {
    window.addEventListener("message", event => {
      if (event.data === "ready") {
        resolve();
      }
    });
  });

  // Load the iframe content that loading it will take 3s.
  const iframe = document.querySelector("iframe");
  iframe.src = "slow_content.sjs";
  await readyPromise;

  await promiseApzFlushedRepaints();

  const displayport = getLastContentDisplayportFor(iframe.contentDocument.documentElement.id);
  isfuzzy(displayport.width, iframe.contentWindow.innerWidth, 1,
     "The displayport width should equal to the window visible area");
  isfuzzy(displayport.height, iframe.contentWindow.innerHeight, 1,
     "The displayport height should equal to the window visible area");
}

waitUntilApzStable()
.then(test)
.then(subtestDone, subtestFailed);
</script>
</html>
