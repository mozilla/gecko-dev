From: Michael Froman <mfroman@mozilla.com>
Date: Tue, 7 Jan 2025 15:30:00 -0600
Subject: Bug 1935474 - BUILD.gn changes to allow building all of
 absl_component_deps. r?ng!

Mercurial Revision: https://hg.mozilla.org/mozilla-central/rev/9cf7afd94407318bb1c39b801d3523db532232e1
---
 abseil-cpp/BUILD.gn                      | 31 ++++++++++--------------
 abseil-cpp/absl/random/internal/BUILD.gn |  5 ++++
 abseil-cpp/absl/strings/BUILD.gn         | 17 -------------
 3 files changed, 18 insertions(+), 35 deletions(-)

diff --git a/abseil-cpp/BUILD.gn b/abseil-cpp/BUILD.gn
index 509010d3a45..e924e997604 100644
--- a/abseil-cpp/BUILD.gn
+++ b/abseil-cpp/BUILD.gn
@@ -56,7 +56,6 @@ component("absl") {
 }
 
 group("absl_component_deps") {
-  if (false) {
   public_deps = [
     "//third_party/abseil-cpp/absl/algorithm",
     "//third_party/abseil-cpp/absl/algorithm:container",
@@ -122,23 +121,6 @@ group("absl_component_deps") {
     # alternative to inject abort hook. See notes in `base/logging.cc`.
     "//third_party/abseil-cpp/absl/base:raw_logging_internal",
   ]
-  } else {
-  public_deps = [
-    "//abseil-cpp/absl/algorithm:container",
-    "//abseil-cpp/absl/base:nullability",
-    "//abseil-cpp/absl/cleanup",
-    "//abseil-cpp/absl/container:inlined_vector",
-    "//abseil-cpp/absl/functional:any_invocable",
-    "//abseil-cpp/absl/functional:bind_front",
-    "//abseil-cpp/absl/strings",
-    "//abseil-cpp/absl/strings:str_format",
-    "//abseil-cpp/absl/strings:string_view",
-    "//abseil-cpp/absl/types:optional",
-    "//abseil-cpp/absl/types:span",
-    "//abseil-cpp/absl/types:variant",
-    "//abseil-cpp/absl/utility",
-  ]
-  }
 
   if (is_component_build) {
     public_deps += [ ":absl_full_deps" ]
@@ -152,6 +134,19 @@ group("absl_component_deps") {
   }
 
   visibility = [ ":absl" ]
+
+  if (moz_webrtc_build) {
+    # rewrite deps for our new abseil-cpp location
+    if (defined(public_deps)) {
+      modified_deps = []
+      foreach (dep, public_deps) {
+        newdep = string_replace(dep, "//third_party/abseil-cpp/", "//")
+        modified_deps += [ newdep ]
+      }
+      public_deps = []
+      public_deps = modified_deps
+    }
+  }
 }
 
 # Some third-party libraries use additional parts of absl that are banned in
diff --git a/abseil-cpp/absl/random/internal/BUILD.gn b/abseil-cpp/absl/random/internal/BUILD.gn
index 3655030b726..2484db587c3 100644
--- a/abseil-cpp/absl/random/internal/BUILD.gn
+++ b/abseil-cpp/absl/random/internal/BUILD.gn
@@ -187,6 +187,11 @@ absl_source_set("platform") {
     "//third_party/abseil-cpp/absl/base:config",
   ]
   visibility = [ "//third_party/abseil-cpp/absl/random/*" ]
+
+  if (moz_webrtc_build) {
+    # We don't really want to run Google's scripting to generate build flags
+    deps -= [ "//build:chromeos_buildflags" ]
+  }
 }
 
 absl_source_set("randen") {
diff --git a/abseil-cpp/absl/strings/BUILD.gn b/abseil-cpp/absl/strings/BUILD.gn
index 6c67dec385b..01eacf20534 100644
--- a/abseil-cpp/absl/strings/BUILD.gn
+++ b/abseil-cpp/absl/strings/BUILD.gn
@@ -15,9 +15,6 @@ absl_source_set("string_view") {
     "//third_party/abseil-cpp/absl/base:nullability",
     "//third_party/abseil-cpp/absl/base:throw_delegate",
   ]
-  if (moz_webrtc_build) {
-    deps -= [ "//third_party/abseil-cpp/absl/base" ]
-  }
 }
 
 absl_source_set("strings") {
@@ -84,20 +81,6 @@ absl_source_set("strings") {
     "//third_party/abseil-cpp/absl/numeric:bits",
     "//third_party/abseil-cpp/absl/numeric:int128",
   ]
-  if (moz_webrtc_build) {
-    # Removed for unreachable sources.  See Bug 1820869.
-    sources -= [
-      "escaping.cc",
-      "str_replace.cc",
-      "substitute.cc",
-    ]
-    deps -= [
-      ":charset",
-      ":internal", # Removed for unreachable sources.  See Bug 1820869.
-      "//third_party/abseil-cpp/absl/base",
-      "//third_party/abseil-cpp/absl/base:endian",
-    ]
-  }
 }
 
 absl_source_set("internal") {
