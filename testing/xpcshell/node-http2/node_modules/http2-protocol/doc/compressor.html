<!DOCTYPE html>

<html>
<head>
  <title>compressor.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="compressor.html">
                compressor.js
              </a>
            
              
              <a class="source" href="connection.html">
                connection.js
              </a>
            
              
              <a class="source" href="endpoint.html">
                endpoint.js
              </a>
            
              
              <a class="source" href="flow.html">
                flow.js
              </a>
            
              
              <a class="source" href="framer.html">
                framer.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="stream.html">
                stream.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>compressor.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>The implementation of the <a href="http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-05">HTTP/2 Header Compression</a> spec is separated from
the &#39;integration&#39; part which handles HEADERS and PUSH_PROMISE frames. The compression itself is
implemented in the first part of the file, and consists of three classes: <code>HeaderTable</code>,
<code>HeaderSetDecompressor</code> and <code>HeaderSetCompressor</code>. The two latter classes are
<a href="http://nodejs.org/api/stream.html#stream_class_stream_transform">Transform Stream</a> subclasses that operate in <a href="http://nodejs.org/api/stream.html#stream_new_stream_readable_options">object mode</a>.
These transform chunks of binary data into <code>[name, value]</code> pairs and vice versa, and store their
state in <code>HeaderTable</code> instances.</p>
<p>The &#39;integration&#39; part is also implemented by two <a href="http://nodejs.org/api/stream.html#stream_class_stream_transform">Transform Stream</a> subclasses
that operate in <a href="http://nodejs.org/api/stream.html#stream_new_stream_readable_options">object mode</a>: the <code>Compressor</code> and the <code>Decompressor</code>. These
provide a layer between the <a href="framer.html">framer</a> and the
<a href="connection.html">connection handling component</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.HeaderTable = HeaderTable;
exports.HuffmanTable = HuffmanTable;
exports.HeaderSetCompressor = HeaderSetCompressor;
exports.HeaderSetDecompressor = HeaderSetDecompressor;
exports.Compressor = Compressor;
exports.Decompressor = Decompressor;

<span class="keyword">var</span> TransformStream = require(<span class="string">'stream'</span>).Transform;
<span class="keyword">var</span> assert = require(<span class="string">'assert'</span>);
<span class="keyword">var</span> util = require(<span class="string">'util'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="header-compression">Header compression</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="the-headertable-class">The HeaderTable class</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The <a href="http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-05#section-3.1.2">Header Table</a> is a component used to associate headers to index values. It is basically an
ordered list of <code>[name, value]</code> pairs, so it&#39;s implemented as a subclass of <code>Array</code>.
In this implementation, the Header Table and the <a href="http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-05#appendix-B">Static Table</a> are handled as a single table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">HeaderTable</span><span class="params">(log, limit)</span> {</span>
  <span class="keyword">var</span> self = HeaderTable.staticTable.map(entryFromPair);
  self._log = log;
  self._limit = limit || DEFAULT_HEADER_TABLE_LIMIT;
  self._staticLength = self.length;
  self._size = <span class="number">0</span>;
  self._enforceLimit = HeaderTable.prototype._enforceLimit;
  self.add = HeaderTable.prototype.add;
  self.setSizeLimit = HeaderTable.prototype.setSizeLimit;
  <span class="keyword">return</span> self;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>There are few more sets that are needed for the compression/decompression process that are all
subsets of the Header Table, and are implemented as flags on header table entries:</p>
<ul>
<li><a href="http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-05#section-3.1.3">Reference Set</a>: contains a group of headers used as a reference for the
differential encoding of a new set of headers. (<code>reference</code> flag)</li>
<li>Emitted headers: the headers that are already emitted as part of the current decompression
process (not part of the spec, <code>emitted</code> flag)</li>
<li>Headers to be kept: headers that should not be removed as the last step of the encoding process
(not part of the spec, <code>keep</code> flag)</li>
</ul>
<p>Relations of the sets:</p>
<pre><code>,----------------------------------.
|           Header Table           |
|                                  |
|  ,----------------------------.  |
|  |        Reference Set       |  |
|  |                            |  |
|  |  ,---------.  ,---------.  |  |
|  |  |  Keep   |  | Emitted |  |  |
|  |  |         |  |         |  |  |
|  |  `---------&#39;  `---------&#39;  |  |
|  `----------------------------&#39;  |
`----------------------------------&#39;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">entryFromPair</span><span class="params">(pair)</span> {</span>
  <span class="keyword">var</span> entry = pair.slice();
  entry.reference = <span class="literal">false</span>;
  entry.emitted = <span class="literal">false</span>;
  entry.keep = <span class="literal">false</span>;
  entry._size = size(entry);
  <span class="keyword">return</span> entry;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The encoder decides how to update the header table and as such can control how much memory is
used by the header table.  To limit the memory requirements on the decoder side, the header table
size is bounded.</p>
<ul>
<li>The default header table size limit is 4096 bytes.</li>
<li>The size of an entry is defined as follows: the size of an entry is the sum of its name&#39;s
length in bytes, of its value&#39;s length in bytes and of 32 bytes.</li>
<li>The size of a header table is the sum of the size of its entries.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> DEFAULT_HEADER_TABLE_LIMIT = <span class="number">4096</span>;

<span class="function"><span class="keyword">function</span> <span class="title">size</span><span class="params">(entry)</span> {</span>
  <span class="keyword">return</span> (<span class="keyword">new</span> Buffer(entry[<span class="number">0</span>] + entry[<span class="number">1</span>], <span class="string">'utf8'</span>)).length + <span class="number">32</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The <code>add(index, entry)</code> can be used to <a href="http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-05#section-3.3">manage the header table</a>:</p>
<ul>
<li>it pushes the new <code>entry</code> at the beggining of the table</li>
<li><p>before doing such a modification, it has to be ensured that the header table size will stay
lower than or equal to the header table size limit. To achieve this, entries are evicted from
the end of the header table until the size of the header table is less than or equal to
<code>(this._limit - entry.size)</code>, or until the table is empty.</p>
<pre><code>       &lt;----------  Index Address Space ----------&gt;
       &lt;-- Header  Table --&gt;  &lt;-- Static  Table --&gt;
       +---+-----------+---+  +---+-----------+---+
       | 0 |    ...    | k |  |k+1|    ...    | n |
       +---+-----------+---+  +---+-----------+---+
       ^                   |
       |                   V
Insertion Point       Drop Point</code></pre>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderTable.prototype._enforceLimit = <span class="function"><span class="keyword">function</span> <span class="title">_enforceLimit</span><span class="params">(limit)</span> {</span>
  <span class="keyword">var</span> droppedEntries = [];
  <span class="keyword">var</span> dropPoint = <span class="keyword">this</span>.length - <span class="keyword">this</span>._staticLength;
  <span class="keyword">while</span> ((<span class="keyword">this</span>._size &gt; limit) &amp;&amp; (dropPoint &gt; <span class="number">0</span>)) {
    dropPoint -= <span class="number">1</span>;
    <span class="keyword">var</span> dropped = <span class="keyword">this</span>.splice(dropPoint, <span class="number">1</span>)[<span class="number">0</span>];
    <span class="keyword">this</span>._size -= dropped._size;
    droppedEntries[droppedEntries] = dropped;
  }
  <span class="keyword">return</span> droppedEntries;
};

HeaderTable.prototype.add = <span class="function"><span class="keyword">function</span><span class="params">(entry)</span> {</span>
  <span class="keyword">var</span> limit = <span class="keyword">this</span>._limit - entry._size;
  <span class="keyword">var</span> droppedEntries = <span class="keyword">this</span>._enforceLimit(limit);

  <span class="keyword">if</span> (<span class="keyword">this</span>._size &lt;= limit) {
    <span class="keyword">this</span>.unshift(entry);
    <span class="keyword">this</span>._size += entry._size;
  }

  <span class="keyword">return</span> droppedEntries;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The table size limit can be changed externally. In this case, the same eviction algorithm is used</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderTable.prototype.setSizeLimit = <span class="function"><span class="keyword">function</span> <span class="title">setSizeLimit</span><span class="params">(limit)</span> {</span>
  <span class="keyword">this</span>._limit = limit;
  <span class="keyword">this</span>._enforceLimit(<span class="keyword">this</span>._limit);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="-the-static-table-http-tools-ietf-org-html-draft-ietf-httpbis-header-compression-05-appendix-b-"><a href="http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-05#appendix-B">The Static Table</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The table is generated with feeding the table from the spec to the following sed command:</p>
<pre><code>sed -re &quot;s/\s*\| [0-9]+\s*\| ([^ ]*)/  [ &#39;\1&#39;/g&quot; -e &quot;s/\|\s([^ ]*)/, &#39;\1&#39;/g&quot; -e &#39;s/ \|/],/g&#39;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderTable.staticTable  = [
  [ <span class="string">':authority'</span>                  , <span class="string">''</span>            ],
  [ <span class="string">':method'</span>                     , <span class="string">'GET'</span>         ],
  [ <span class="string">':method'</span>                     , <span class="string">'POST'</span>        ],
  [ <span class="string">':path'</span>                       , <span class="string">'/'</span>           ],
  [ <span class="string">':path'</span>                       , <span class="string">'/index.html'</span> ],
  [ <span class="string">':scheme'</span>                     , <span class="string">'http'</span>        ],
  [ <span class="string">':scheme'</span>                     , <span class="string">'https'</span>       ],
  [ <span class="string">':status'</span>                     , <span class="string">'200'</span>         ],
  [ <span class="string">':status'</span>                     , <span class="string">'500'</span>         ],
  [ <span class="string">':status'</span>                     , <span class="string">'404'</span>         ],
  [ <span class="string">':status'</span>                     , <span class="string">'403'</span>         ],
  [ <span class="string">':status'</span>                     , <span class="string">'400'</span>         ],
  [ <span class="string">':status'</span>                     , <span class="string">'401'</span>         ],
  [ <span class="string">'accept-charset'</span>              , <span class="string">''</span>            ],
  [ <span class="string">'accept-encoding'</span>             , <span class="string">''</span>            ],
  [ <span class="string">'accept-language'</span>             , <span class="string">''</span>            ],
  [ <span class="string">'accept-ranges'</span>               , <span class="string">''</span>            ],
  [ <span class="string">'accept'</span>                      , <span class="string">''</span>            ],
  [ <span class="string">'access-control-allow-origin'</span> , <span class="string">''</span>            ],
  [ <span class="string">'age'</span>                         , <span class="string">''</span>            ],
  [ <span class="string">'allow'</span>                       , <span class="string">''</span>            ],
  [ <span class="string">'authorization'</span>               , <span class="string">''</span>            ],
  [ <span class="string">'cache-control'</span>               , <span class="string">''</span>            ],
  [ <span class="string">'content-disposition'</span>         , <span class="string">''</span>            ],
  [ <span class="string">'content-encoding'</span>            , <span class="string">''</span>            ],
  [ <span class="string">'content-language'</span>            , <span class="string">''</span>            ],
  [ <span class="string">'content-length'</span>              , <span class="string">''</span>            ],
  [ <span class="string">'content-location'</span>            , <span class="string">''</span>            ],
  [ <span class="string">'content-range'</span>               , <span class="string">''</span>            ],
  [ <span class="string">'content-type'</span>                , <span class="string">''</span>            ],
  [ <span class="string">'cookie'</span>                      , <span class="string">''</span>            ],
  [ <span class="string">'date'</span>                        , <span class="string">''</span>            ],
  [ <span class="string">'etag'</span>                        , <span class="string">''</span>            ],
  [ <span class="string">'expect'</span>                      , <span class="string">''</span>            ],
  [ <span class="string">'expires'</span>                     , <span class="string">''</span>            ],
  [ <span class="string">'from'</span>                        , <span class="string">''</span>            ],
  [ <span class="string">'host'</span>                        , <span class="string">''</span>            ],
  [ <span class="string">'if-match'</span>                    , <span class="string">''</span>            ],
  [ <span class="string">'if-modified-since'</span>           , <span class="string">''</span>            ],
  [ <span class="string">'if-none-match'</span>               , <span class="string">''</span>            ],
  [ <span class="string">'if-range'</span>                    , <span class="string">''</span>            ],
  [ <span class="string">'if-unmodified-since'</span>         , <span class="string">''</span>            ],
  [ <span class="string">'last-modified'</span>               , <span class="string">''</span>            ],
  [ <span class="string">'link'</span>                        , <span class="string">''</span>            ],
  [ <span class="string">'location'</span>                    , <span class="string">''</span>            ],
  [ <span class="string">'max-forwards'</span>                , <span class="string">''</span>            ],
  [ <span class="string">'proxy-authenticate'</span>          , <span class="string">''</span>            ],
  [ <span class="string">'proxy-authorization'</span>         , <span class="string">''</span>            ],
  [ <span class="string">'range'</span>                       , <span class="string">''</span>            ],
  [ <span class="string">'referer'</span>                     , <span class="string">''</span>            ],
  [ <span class="string">'refresh'</span>                     , <span class="string">''</span>            ],
  [ <span class="string">'retry-after'</span>                 , <span class="string">''</span>            ],
  [ <span class="string">'server'</span>                      , <span class="string">''</span>            ],
  [ <span class="string">'set-cookie'</span>                  , <span class="string">''</span>            ],
  [ <span class="string">'strict-transport-security'</span>   , <span class="string">''</span>            ],
  [ <span class="string">'transfer-encoding'</span>           , <span class="string">''</span>            ],
  [ <span class="string">'user-agent'</span>                  , <span class="string">''</span>            ],
  [ <span class="string">'vary'</span>                        , <span class="string">''</span>            ],
  [ <span class="string">'via'</span>                         , <span class="string">''</span>            ],
  [ <span class="string">'www-authenticate'</span>            , <span class="string">''</span>            ]
];</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="the-headersetdecompressor-class">The HeaderSetDecompressor class</h2>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>A <code>HeaderSetDecompressor</code> instance is a transform stream that can be used to <em>decompress a
single header set</em>. Its input is a stream of binary data chunks and its output is a stream of
<code>[name, value]</code> pairs.</p>
<p>Currently, it is not a proper streaming decompressor implementation, since it buffer its input
until the end os the stream, and then processes the whole header block at once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>util.inherits(HeaderSetDecompressor, TransformStream);
<span class="function"><span class="keyword">function</span> <span class="title">HeaderSetDecompressor</span><span class="params">(log, table, huffmanTable)</span> {</span>
  TransformStream.call(<span class="keyword">this</span>, { objectMode: <span class="literal">true</span> });

  <span class="keyword">this</span>._log = log.child({ component: <span class="string">'compressor'</span> });
  <span class="keyword">this</span>._table = table;
  <span class="keyword">this</span>._huffmanTable = huffmanTable;
  <span class="keyword">this</span>._chunks = [];
}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><code>_transform</code> is the implementation of the <a href="http://nodejs.org/api/stream.html#stream_transform_transform_chunk_encoding_callback">corresponding virtual function</a> of the
TransformStream class. It collects the data chunks for later processing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderSetDecompressor.prototype._transform = <span class="function"><span class="keyword">function</span> <span class="title">_transform</span><span class="params">(chunk, encoding, callback)</span> {</span>
  <span class="keyword">this</span>._chunks.push(chunk);
  callback();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><code>execute(rep)</code> executes the given <a href="http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-05#section-3.1.4">header representation</a>.</p>
<p>The <em>JavaScript object representation</em> of a header representation:</p>
<pre><code>{
  name: String || Integer,  // string literal or index
  value: String || Integer, // string literal or index
  index: Boolean            // with or without indexing
}</code></pre>
<p><em>Important:</em> to ease the indexing of the header table, indexes start at 0 instead of 1.</p>
<p>Examples:</p>
<pre><code>Indexed:
{ name: 2  , value: 2  , index: false }
{ name: -1 , value: -1 , index: false } // reference set emptying
Literal:
{ name: 2  , value: &#39;X&#39;, index: false } // without indexing
{ name: 2  , value: &#39;Y&#39;, index: true  } // with indexing
{ name: &#39;A&#39;, value: &#39;Z&#39;, index: true  } // with indexing, literal name</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderSetDecompressor.prototype._execute = <span class="function"><span class="keyword">function</span> <span class="title">_execute</span><span class="params">(rep)</span> {</span>
  <span class="keyword">this</span>._log.trace({ key: rep.name, value: rep.value, index: rep.index },
                  <span class="string">'Executing header representation'</span>);

  <span class="keyword">var</span> entry, pair;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <ul>
<li>An <em>indexed representation</em> with an index value of 0 (in our representation, it means -1)
entails the following actions:<ul>
<li>The reference set is emptied.</li>
</ul>
</li>
<li>An <em>indexed representation</em> corresponding to an entry <em>present</em> in the reference set
entails the following actions:<ul>
<li>The entry is removed from the reference set.</li>
</ul>
</li>
<li>An <em>indexed representation</em> corresponding to an entry <em>not present</em> in the reference set
entails the following actions:<ul>
<li>If referencing an element of the static table:<ul>
<li>The header field corresponding to the referenced entry is emitted</li>
<li>The referenced static entry is added to the header table</li>
<li>A reference to this new header table entry is added to the reference set (except if
this new entry didn&#39;t fit in the header table)</li>
</ul>
</li>
<li>If referencing an element of the header table:<ul>
<li>The header field corresponding to the referenced entry is emitted</li>
<li>The referenced header table entry is added to the reference set</li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (<span class="keyword">typeof</span> rep.value === <span class="string">'number'</span>) {
    <span class="keyword">var</span> index = rep.value;
    entry = <span class="keyword">this</span>._table[index];

    <span class="keyword">if</span> (index == -<span class="number">1</span>) {
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>._table.length; i++) {
        <span class="keyword">this</span>._table[i].reference = <span class="literal">false</span>;
      }
    }

    <span class="keyword">else</span> <span class="keyword">if</span> (entry.reference) {
      entry.reference = <span class="literal">false</span>;
    }

    <span class="keyword">else</span> {
      pair = entry.slice();
      <span class="keyword">this</span>.push(pair);

      <span class="keyword">if</span> (index &gt;= <span class="keyword">this</span>._table.length - <span class="keyword">this</span>._table._staticLength) {
        entry = entryFromPair(pair);
        <span class="keyword">this</span>._table.add(entry);
      }

      entry.reference = <span class="literal">true</span>;
      entry.emitted = <span class="literal">true</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <ul>
<li>A <em>literal representation</em> that is <em>not added</em> to the header table entails the following
action:<ul>
<li>The header is emitted.</li>
</ul>
</li>
<li>A <em>literal representation</em> that is <em>added</em> to the header table entails the following further
actions:<ul>
<li>The header is added to the header table.</li>
<li>The new entry is added to the reference set.</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">else</span> {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> rep.name === <span class="string">'number'</span>) {
      pair = [<span class="keyword">this</span>._table[rep.name][<span class="number">0</span>], rep.value];
    } <span class="keyword">else</span> {
      pair = [rep.name, rep.value];
    }

    <span class="keyword">if</span> (rep.index) {
      entry = entryFromPair(pair);
      entry.reference = <span class="literal">true</span>;
      entry.emitted = <span class="literal">true</span>;
      <span class="keyword">this</span>._table.add(entry);
    }

    <span class="keyword">this</span>.push(pair);
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><code>_flush</code> is the implementation of the <a href="http://nodejs.org/api/stream.html#stream_transform_flush_callback">corresponding virtual function</a> of the
TransformStream class. The whole decompressing process is done in <code>_flush</code>. It gets called when
the input stream is over.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderSetDecompressor.prototype._flush = <span class="function"><span class="keyword">function</span> <span class="title">_flush</span><span class="params">(callback)</span> {</span>
  <span class="keyword">var</span> buffer = concat(<span class="keyword">this</span>._chunks);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <ul>
<li>processes the header representations</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  buffer.cursor = <span class="number">0</span>;
  <span class="keyword">while</span> (buffer.cursor &lt; buffer.length) {
    <span class="keyword">this</span>._execute(HeaderSetDecompressor.header(buffer, <span class="keyword">this</span>._huffmanTable));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <ul>
<li><a href="http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-05#section-3.2.2">emits the reference set</a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; <span class="keyword">this</span>._table.length; index++) {
    <span class="keyword">var</span> entry = <span class="keyword">this</span>._table[index];
    <span class="keyword">if</span> (entry.reference &amp;&amp; !entry.emitted) {
      <span class="keyword">this</span>.push(entry.slice());
    }
    entry.emitted = <span class="literal">false</span>;
  }

  callback();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="the-headersetcompressor-class">The HeaderSetCompressor class</h2>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>A <code>HeaderSetCompressor</code> instance is a transform stream that can be used to <em>compress a single
header set</em>. Its input is a stream of <code>[name, value]</code> pairs and its output is a stream of
binary data chunks.</p>
<p>It is a real streaming compressor, since it does not wait until the header set is complete.</p>
<p>The compression algorithm is (intentionally) not specified by the spec. Therefore, the current
compression algorithm can probably be improved in the future.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>util.inherits(HeaderSetCompressor, TransformStream);
<span class="function"><span class="keyword">function</span> <span class="title">HeaderSetCompressor</span><span class="params">(log, table, huffmanTable)</span> {</span>
  TransformStream.call(<span class="keyword">this</span>, { objectMode: <span class="literal">true</span> });

  <span class="keyword">this</span>._log = log.child({ component: <span class="string">'compressor'</span> });
  <span class="keyword">this</span>._table = table;
  <span class="keyword">this</span>._huffmanTable = huffmanTable;
  <span class="keyword">this</span>.push = TransformStream.prototype.push.bind(<span class="keyword">this</span>);
}

HeaderSetCompressor.prototype.send = <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">(rep)</span> {</span>
  <span class="keyword">this</span>._log.trace({ key: rep.name, value: rep.value, index: rep.index },
                  <span class="string">'Emitting header representation'</span>);

  <span class="keyword">if</span> (!rep.chunks) {
    rep.chunks = HeaderSetCompressor.header(rep, <span class="keyword">this</span>._huffmanTable);
  }
  rep.chunks.forEach(<span class="keyword">this</span>.push);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><code>_transform</code> is the implementation of the <a href="http://nodejs.org/api/stream.html#stream_transform_transform_chunk_encoding_callback">corresponding virtual function</a> of the
TransformStream class. It processes the input headers one by one:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderSetCompressor.prototype._transform = <span class="function"><span class="keyword">function</span> <span class="title">_transform</span><span class="params">(pair, encoding, callback)</span> {</span>
  <span class="keyword">var</span> name = pair[<span class="number">0</span>].toLowerCase();
  <span class="keyword">var</span> value = pair[<span class="number">1</span>];
  <span class="keyword">var</span> entry, rep;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <ul>
<li>tries to find full (name, value) or name match in the header table</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> nameMatch = -<span class="number">1</span>, fullMatch = -<span class="number">1</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> droppedIndex = <span class="number">0</span>; droppedIndex &lt; <span class="keyword">this</span>._table.length; droppedIndex++) {
    entry = <span class="keyword">this</span>._table[droppedIndex];
    <span class="keyword">if</span> (entry[<span class="number">0</span>] === name) {
      <span class="keyword">if</span> (entry[<span class="number">1</span>] === value) {
        fullMatch = droppedIndex;
        <span class="keyword">break</span>;
      } <span class="keyword">else</span> <span class="keyword">if</span> (nameMatch === -<span class="number">1</span>) {
        nameMatch = droppedIndex;
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <ul>
<li><p>if there&#39;s full match, it will be an indexed representation (or more than one) depending
on its presence in the reference, the emitted and the keep set:</p>
<ul>
<li><p>If the entry is outside the reference set, then a single indexed representation puts the
entry into it and emits the header. Note that if the matched entry is in the static table,
then it has to be added to the header table.</p>
</li>
<li><p>If it&#39;s already in the keep set, then 4 indexed representations are needed:</p>
<ol>
<li>removes it from the reference set</li>
<li>puts it back in the reference set and emits the header once</li>
<li>removes it again</li>
<li>puts it back and emits it again for the second time</li>
</ol>
<p>It won&#39;t be emitted at the end of the decoding process since it&#39;s now in the emitted set.</p>
</li>
<li><p>If it&#39;s in the emitted set, then 2 indexed representations are needed:</p>
<ol>
<li>removes it from the reference set</li>
<li>puts it back in the reference set and emits the header once</li>
</ol>
</li>
<li><p>If it&#39;s in the reference set, but outside the keep set and the emitted set, then this
header is common with the previous header set, and is still untouched. We mark it to keep
in the reference set (that means don&#39;t remove at the end of the encoding process).</p>
</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (fullMatch !== -<span class="number">1</span>) {
    rep = { name: fullMatch, value: fullMatch, index: <span class="literal">false</span> };

    <span class="keyword">if</span> (!entry.reference) {
      <span class="keyword">if</span> (fullMatch &gt;= <span class="keyword">this</span>._table.length - <span class="keyword">this</span>._table._staticLength) {
        entry = entryFromPair(pair);
        <span class="keyword">this</span>._table.add(entry);
      }
      <span class="keyword">this</span>.send(rep);
      entry.reference = <span class="literal">true</span>;
      entry.emitted = <span class="literal">true</span>;
    }

    <span class="keyword">else</span> <span class="keyword">if</span> (entry.keep) {
      <span class="keyword">this</span>.send(rep);
      <span class="keyword">this</span>.send(rep);
      <span class="keyword">this</span>.send(rep);
      <span class="keyword">this</span>.send(rep);
      entry.keep = <span class="literal">false</span>;
      entry.emitted = <span class="literal">true</span>;
    }

    <span class="keyword">else</span> <span class="keyword">if</span> (entry.emitted) {
      <span class="keyword">this</span>.send(rep);
      <span class="keyword">this</span>.send(rep);
    }

    <span class="keyword">else</span> {
      entry.keep = <span class="literal">true</span>;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <ul>
<li>otherwise, it will be a literal representation (with a name index if there&#39;s a name match)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">else</span> {
    entry = entryFromPair(pair);
    entry.emitted = <span class="literal">true</span>;

    <span class="keyword">var</span> indexing = (entry._size &lt; <span class="keyword">this</span>._table._limit / <span class="number">2</span>);

    <span class="keyword">if</span> (indexing) {
      entry.reference = <span class="literal">true</span>;
      <span class="keyword">var</span> droppedEntries = <span class="keyword">this</span>._table.add(entry);
      <span class="keyword">for</span> (droppedIndex <span class="keyword">in</span> droppedEntries) {
        <span class="keyword">var</span> dropped = droppedEntries[droppedIndex];
        <span class="keyword">if</span> (dropped.keep) {
          rep = { name: droppedIndex, value: droppedIndex, index: <span class="literal">false</span> };
          <span class="keyword">this</span>.send(rep);
          <span class="keyword">this</span>.send(rep);
        }
      }
    }

    <span class="keyword">this</span>.send({ name: (nameMatch !== -<span class="number">1</span>) ? nameMatch : name, value: value, index: indexing });
  }

  callback();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><code>_flush</code> is the implementation of the <a href="http://nodejs.org/api/stream.html#stream_transform_flush_callback">corresponding virtual function</a> of the
TransformStream class. It gets called when there&#39;s no more header to compress. The final step:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderSetCompressor.prototype._flush = <span class="function"><span class="keyword">function</span> <span class="title">_flush</span><span class="params">(callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <ul>
<li>removing entries from the header set that are not marked to be kept or emitted</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; <span class="keyword">this</span>._table.length; index++) {
    <span class="keyword">var</span> entry = <span class="keyword">this</span>._table[index];
    <span class="keyword">if</span> (entry.reference &amp;&amp; !entry.keep &amp;&amp; !entry.emitted) {
      <span class="keyword">this</span>.send({ name: index, value: index, index: <span class="literal">false</span> });
      entry.reference = <span class="literal">false</span>;
    }
    entry.keep = <span class="literal">false</span>;
    entry.emitted = <span class="literal">false</span>;
  }

  callback();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h2 id="-detailed-format-http-tools-ietf-org-html-draft-ietf-httpbis-header-compression-05-section-4-"><a href="http://tools.ietf.org/html/draft-ietf-httpbis-header-compression-05#section-4">Detailed Format</a></h2>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3 id="integer-representation">Integer representation</h3>
<p>The algorithm to represent an integer I is as follows:</p>
<ol>
<li>If I &lt; 2^N - 1, encode I on N bits</li>
<li>Else, encode 2^N - 1 on N bits and do the following steps:<ol>
<li>Set I to (I - (2^N - 1)) and Q to 1</li>
<li>While Q &gt; 0<ol>
<li>Compute Q and R, quotient and remainder of I divided by 2^7</li>
<li>If Q is strictly greater than 0, write one 1 bit; otherwise, write one 0 bit</li>
<li>Encode R on the next 7 bits</li>
<li>I = Q</li>
</ol>
</li>
</ol>
</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderSetCompressor.integer = <span class="function"><span class="keyword">function</span> <span class="title">writeInteger</span><span class="params">(I, N)</span> {</span>
  <span class="keyword">var</span> limit = Math.pow(<span class="number">2</span>,N) - <span class="number">1</span>;
  <span class="keyword">if</span> (I &lt; limit) {
    <span class="keyword">return</span> [<span class="keyword">new</span> Buffer([I])];
  }

  <span class="keyword">var</span> bytes = [];
  <span class="keyword">if</span> (N !== <span class="number">0</span>) {
    bytes.push(limit);
  }
  I -= limit;

  <span class="keyword">var</span> Q = <span class="number">1</span>, R;
  <span class="keyword">while</span> (Q &gt; <span class="number">0</span>) {
    Q = Math.floor(I / <span class="number">128</span>);
    R = I % <span class="number">128</span>;

    <span class="keyword">if</span> (Q &gt; <span class="number">0</span>) {
      R += <span class="number">128</span>;
    }
    bytes.push(R);

    I = Q;
  }

  <span class="keyword">return</span> [<span class="keyword">new</span> Buffer(bytes)];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>The inverse algorithm:</p>
<ol>
<li>Set I to the number coded on the lower N bits of the first byte</li>
<li>If I is smaller than 2^N - 1 then return I</li>
<li>Else the number is encoded on more than one byte, so do the following steps:<ol>
<li>Set M to 0</li>
<li>While returning with I<ol>
<li>Let B be the next byte (the first byte if N is 0)</li>
<li>Read out the lower 7 bits of B and multiply it with 2^M</li>
<li>Increase I with this number</li>
<li>Increase M by 7</li>
<li>Return I if the most significant bit of B is 0</li>
</ol>
</li>
</ol>
</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderSetDecompressor.integer = <span class="function"><span class="keyword">function</span> <span class="title">readInteger</span><span class="params">(buffer, N)</span> {</span>
  <span class="keyword">var</span> limit = Math.pow(<span class="number">2</span>,N) - <span class="number">1</span>;

  <span class="keyword">var</span> I = buffer[buffer.cursor] &amp; limit;
  <span class="keyword">if</span> (N !== <span class="number">0</span>) {
    buffer.cursor += <span class="number">1</span>;
  }

  <span class="keyword">if</span> (I === limit) {
    <span class="keyword">var</span> M = <span class="number">0</span>;
    <span class="keyword">do</span> {
      I += (buffer[buffer.cursor] &amp; <span class="number">127</span>) &lt;&lt; M;
      M += <span class="number">7</span>;
      buffer.cursor += <span class="number">1</span>;
    } <span class="keyword">while</span> (buffer[buffer.cursor - <span class="number">1</span>] &amp; <span class="number">128</span>);
  }

  <span class="keyword">return</span> I;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h3 id="huffman-encoding">Huffman Encoding</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">HuffmanTable</span><span class="params">(table)</span> {</span>
  <span class="function"><span class="keyword">function</span> <span class="title">createTree</span><span class="params">(codes, position)</span> {</span>
    <span class="keyword">if</span> (codes.length === <span class="number">1</span>) {
      <span class="keyword">return</span> [table.indexOf(codes[<span class="number">0</span>])];
    }

    <span class="keyword">else</span> {
      position = position || <span class="number">0</span>;
      <span class="keyword">var</span> zero = [];
      <span class="keyword">var</span> one = [];
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; codes.length; i++) {
        <span class="keyword">var</span> string = codes[i];
        <span class="keyword">if</span> (string[position] === <span class="string">'0'</span>) {
          zero.push(string);
        } <span class="keyword">else</span> {
          one.push(string);
        }
      }
      <span class="keyword">return</span> [createTree(zero, position + <span class="number">1</span>), createTree(one, position + <span class="number">1</span>)];
    }
  }

  <span class="keyword">this</span>.tree = createTree(table);

  <span class="keyword">this</span>.codes = table.map(<span class="function"><span class="keyword">function</span><span class="params">(bits)</span> {</span>
    <span class="keyword">return</span> parseInt(bits, <span class="number">2</span>);
  });
  <span class="keyword">this</span>.lengths = table.map(<span class="function"><span class="keyword">function</span><span class="params">(bits)</span> {</span>
    <span class="keyword">return</span> bits.length;
  });
}

HuffmanTable.prototype.encode = <span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">(buffer)</span> {</span>
  <span class="keyword">var</span> result = [];
  <span class="keyword">var</span> space = <span class="number">8</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(data)</span> {</span>
    <span class="keyword">if</span> (space === <span class="number">8</span>) {
      result.push(data);
    } <span class="keyword">else</span> {
      result[result.length - <span class="number">1</span>] |= data;
    }
  }

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; buffer.length; i++) {
    <span class="keyword">var</span> byte = buffer[i];
    <span class="keyword">var</span> code = <span class="keyword">this</span>.codes[byte];
    <span class="keyword">var</span> length = <span class="keyword">this</span>.lengths[byte];

    <span class="keyword">while</span> (length !== <span class="number">0</span>) {
      <span class="keyword">if</span> (space &gt;= length) {
        add(code &lt;&lt; (space - length));
        code = <span class="number">0</span>;
        space -= length;
        length = <span class="number">0</span>;
      } <span class="keyword">else</span> {
        <span class="keyword">var</span> shift = length - space;
        <span class="keyword">var</span> msb = code &gt;&gt; shift;
        add(msb);
        code -= msb &lt;&lt; shift;
        length -= space;
        space = <span class="number">0</span>;
      }

      <span class="keyword">if</span> (space === <span class="number">0</span>) {
        space = <span class="number">8</span>;
      }
    }
  }

  <span class="keyword">if</span> (space !== <span class="number">8</span>) {
    add(<span class="keyword">this</span>.codes[<span class="number">256</span>] &gt;&gt; (<span class="keyword">this</span>.lengths[<span class="number">256</span>] - space));
  }

  <span class="keyword">return</span> <span class="keyword">new</span> Buffer(result);
}

HuffmanTable.prototype.decode = <span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">(buffer)</span> {</span>
  <span class="keyword">var</span> result = [];
  <span class="keyword">var</span> subtree = <span class="keyword">this</span>.tree;

  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; buffer.length; i++) {
    <span class="keyword">var</span> byte = buffer[i];

    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) {
      <span class="keyword">var</span> bit = (byte &amp; <span class="number">128</span>) ? <span class="number">1</span> : <span class="number">0</span>;
      byte = byte &lt;&lt; <span class="number">1</span>;

      subtree = subtree[bit];
      <span class="keyword">if</span> (subtree.length === <span class="number">1</span>) {
        result.push(subtree[<span class="number">0</span>]);
        subtree = <span class="keyword">this</span>.tree;
      }
    }
  }

  <span class="keyword">return</span> <span class="keyword">new</span> Buffer(result);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>The initializer arrays for the Huffman tables are generated with feeding the tables from the
spec to this sed command:</p>
<pre><code>sed -e &quot;s/^.* [|]//g&quot; -e &quot;s/|//g&quot; -e &quot;s/ .*//g&quot; -e &quot;s/^/  &#39;/g&quot; -e &quot;s/$/&#39;,/g&quot;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>HuffmanTable.requestHuffmanTable = <span class="keyword">new</span> HuffmanTable([
  <span class="string">'111111111111111111110111010'</span>,
  <span class="string">'111111111111111111110111011'</span>,
  <span class="string">'111111111111111111110111100'</span>,
  <span class="string">'111111111111111111110111101'</span>,
  <span class="string">'111111111111111111110111110'</span>,
  <span class="string">'111111111111111111110111111'</span>,
  <span class="string">'111111111111111111111000000'</span>,
  <span class="string">'111111111111111111111000001'</span>,
  <span class="string">'111111111111111111111000010'</span>,
  <span class="string">'111111111111111111111000011'</span>,
  <span class="string">'111111111111111111111000100'</span>,
  <span class="string">'111111111111111111111000101'</span>,
  <span class="string">'111111111111111111111000110'</span>,
  <span class="string">'111111111111111111111000111'</span>,
  <span class="string">'111111111111111111111001000'</span>,
  <span class="string">'111111111111111111111001001'</span>,
  <span class="string">'111111111111111111111001010'</span>,
  <span class="string">'111111111111111111111001011'</span>,
  <span class="string">'111111111111111111111001100'</span>,
  <span class="string">'111111111111111111111001101'</span>,
  <span class="string">'111111111111111111111001110'</span>,
  <span class="string">'111111111111111111111001111'</span>,
  <span class="string">'111111111111111111111010000'</span>,
  <span class="string">'111111111111111111111010001'</span>,
  <span class="string">'111111111111111111111010010'</span>,
  <span class="string">'111111111111111111111010011'</span>,
  <span class="string">'111111111111111111111010100'</span>,
  <span class="string">'111111111111111111111010101'</span>,
  <span class="string">'111111111111111111111010110'</span>,
  <span class="string">'111111111111111111111010111'</span>,
  <span class="string">'111111111111111111111011000'</span>,
  <span class="string">'111111111111111111111011001'</span>,
  <span class="string">'11101000'</span>,
  <span class="string">'111111111100'</span>,
  <span class="string">'11111111111010'</span>,
  <span class="string">'111111111111100'</span>,
  <span class="string">'111111111111101'</span>,
  <span class="string">'100100'</span>,
  <span class="string">'1101110'</span>,
  <span class="string">'111111111111110'</span>,
  <span class="string">'11111111010'</span>,
  <span class="string">'11111111011'</span>,
  <span class="string">'1111111010'</span>,
  <span class="string">'11111111100'</span>,
  <span class="string">'11101001'</span>,
  <span class="string">'100101'</span>,
  <span class="string">'00100'</span>,
  <span class="string">'0000'</span>,
  <span class="string">'00101'</span>,
  <span class="string">'00110'</span>,
  <span class="string">'00111'</span>,
  <span class="string">'100110'</span>,
  <span class="string">'100111'</span>,
  <span class="string">'101000'</span>,
  <span class="string">'101001'</span>,
  <span class="string">'101010'</span>,
  <span class="string">'101011'</span>,
  <span class="string">'101100'</span>,
  <span class="string">'111101100'</span>,
  <span class="string">'11101010'</span>,
  <span class="string">'111111111111111110'</span>,
  <span class="string">'101101'</span>,
  <span class="string">'11111111111111100'</span>,
  <span class="string">'111101101'</span>,
  <span class="string">'11111111111011'</span>,
  <span class="string">'1101111'</span>,
  <span class="string">'11101011'</span>,
  <span class="string">'11101100'</span>,
  <span class="string">'11101101'</span>,
  <span class="string">'11101110'</span>,
  <span class="string">'1110000'</span>,
  <span class="string">'111101110'</span>,
  <span class="string">'111101111'</span>,
  <span class="string">'111110000'</span>,
  <span class="string">'111110001'</span>,
  <span class="string">'1111111011'</span>,
  <span class="string">'111110010'</span>,
  <span class="string">'11101111'</span>,
  <span class="string">'111110011'</span>,
  <span class="string">'111110100'</span>,
  <span class="string">'111110101'</span>,
  <span class="string">'111110110'</span>,
  <span class="string">'111110111'</span>,
  <span class="string">'11110000'</span>,
  <span class="string">'11110001'</span>,
  <span class="string">'111111000'</span>,
  <span class="string">'111111001'</span>,
  <span class="string">'111111010'</span>,
  <span class="string">'111111011'</span>,
  <span class="string">'111111100'</span>,
  <span class="string">'1111111100'</span>,
  <span class="string">'11111111111100'</span>,
  <span class="string">'111111111111111111111011010'</span>,
  <span class="string">'1111111111100'</span>,
  <span class="string">'11111111111101'</span>,
  <span class="string">'101110'</span>,
  <span class="string">'1111111111111111110'</span>,
  <span class="string">'01000'</span>,
  <span class="string">'101111'</span>,
  <span class="string">'01001'</span>,
  <span class="string">'110000'</span>,
  <span class="string">'0001'</span>,
  <span class="string">'110001'</span>,
  <span class="string">'110010'</span>,
  <span class="string">'110011'</span>,
  <span class="string">'01010'</span>,
  <span class="string">'1110001'</span>,
  <span class="string">'1110010'</span>,
  <span class="string">'01011'</span>,
  <span class="string">'110100'</span>,
  <span class="string">'01100'</span>,
  <span class="string">'01101'</span>,
  <span class="string">'01110'</span>,
  <span class="string">'11110010'</span>,
  <span class="string">'01111'</span>,
  <span class="string">'10000'</span>,
  <span class="string">'10001'</span>,
  <span class="string">'110101'</span>,
  <span class="string">'1110011'</span>,
  <span class="string">'110110'</span>,
  <span class="string">'11110011'</span>,
  <span class="string">'11110100'</span>,
  <span class="string">'11110101'</span>,
  <span class="string">'11111111111111101'</span>,
  <span class="string">'11111111101'</span>,
  <span class="string">'11111111111111110'</span>,
  <span class="string">'111111111101'</span>,
  <span class="string">'111111111111111111111011011'</span>,
  <span class="string">'111111111111111111111011100'</span>,
  <span class="string">'111111111111111111111011101'</span>,
  <span class="string">'111111111111111111111011110'</span>,
  <span class="string">'111111111111111111111011111'</span>,
  <span class="string">'111111111111111111111100000'</span>,
  <span class="string">'111111111111111111111100001'</span>,
  <span class="string">'111111111111111111111100010'</span>,
  <span class="string">'111111111111111111111100011'</span>,
  <span class="string">'111111111111111111111100100'</span>,
  <span class="string">'111111111111111111111100101'</span>,
  <span class="string">'111111111111111111111100110'</span>,
  <span class="string">'111111111111111111111100111'</span>,
  <span class="string">'111111111111111111111101000'</span>,
  <span class="string">'111111111111111111111101001'</span>,
  <span class="string">'111111111111111111111101010'</span>,
  <span class="string">'111111111111111111111101011'</span>,
  <span class="string">'111111111111111111111101100'</span>,
  <span class="string">'111111111111111111111101101'</span>,
  <span class="string">'111111111111111111111101110'</span>,
  <span class="string">'111111111111111111111101111'</span>,
  <span class="string">'111111111111111111111110000'</span>,
  <span class="string">'111111111111111111111110001'</span>,
  <span class="string">'111111111111111111111110010'</span>,
  <span class="string">'111111111111111111111110011'</span>,
  <span class="string">'111111111111111111111110100'</span>,
  <span class="string">'111111111111111111111110101'</span>,
  <span class="string">'111111111111111111111110110'</span>,
  <span class="string">'111111111111111111111110111'</span>,
  <span class="string">'111111111111111111111111000'</span>,
  <span class="string">'111111111111111111111111001'</span>,
  <span class="string">'111111111111111111111111010'</span>,
  <span class="string">'111111111111111111111111011'</span>,
  <span class="string">'111111111111111111111111100'</span>,
  <span class="string">'111111111111111111111111101'</span>,
  <span class="string">'111111111111111111111111110'</span>,
  <span class="string">'111111111111111111111111111'</span>,
  <span class="string">'11111111111111111110000000'</span>,
  <span class="string">'11111111111111111110000001'</span>,
  <span class="string">'11111111111111111110000010'</span>,
  <span class="string">'11111111111111111110000011'</span>,
  <span class="string">'11111111111111111110000100'</span>,
  <span class="string">'11111111111111111110000101'</span>,
  <span class="string">'11111111111111111110000110'</span>,
  <span class="string">'11111111111111111110000111'</span>,
  <span class="string">'11111111111111111110001000'</span>,
  <span class="string">'11111111111111111110001001'</span>,
  <span class="string">'11111111111111111110001010'</span>,
  <span class="string">'11111111111111111110001011'</span>,
  <span class="string">'11111111111111111110001100'</span>,
  <span class="string">'11111111111111111110001101'</span>,
  <span class="string">'11111111111111111110001110'</span>,
  <span class="string">'11111111111111111110001111'</span>,
  <span class="string">'11111111111111111110010000'</span>,
  <span class="string">'11111111111111111110010001'</span>,
  <span class="string">'11111111111111111110010010'</span>,
  <span class="string">'11111111111111111110010011'</span>,
  <span class="string">'11111111111111111110010100'</span>,
  <span class="string">'11111111111111111110010101'</span>,
  <span class="string">'11111111111111111110010110'</span>,
  <span class="string">'11111111111111111110010111'</span>,
  <span class="string">'11111111111111111110011000'</span>,
  <span class="string">'11111111111111111110011001'</span>,
  <span class="string">'11111111111111111110011010'</span>,
  <span class="string">'11111111111111111110011011'</span>,
  <span class="string">'11111111111111111110011100'</span>,
  <span class="string">'11111111111111111110011101'</span>,
  <span class="string">'11111111111111111110011110'</span>,
  <span class="string">'11111111111111111110011111'</span>,
  <span class="string">'11111111111111111110100000'</span>,
  <span class="string">'11111111111111111110100001'</span>,
  <span class="string">'11111111111111111110100010'</span>,
  <span class="string">'11111111111111111110100011'</span>,
  <span class="string">'11111111111111111110100100'</span>,
  <span class="string">'11111111111111111110100101'</span>,
  <span class="string">'11111111111111111110100110'</span>,
  <span class="string">'11111111111111111110100111'</span>,
  <span class="string">'11111111111111111110101000'</span>,
  <span class="string">'11111111111111111110101001'</span>,
  <span class="string">'11111111111111111110101010'</span>,
  <span class="string">'11111111111111111110101011'</span>,
  <span class="string">'11111111111111111110101100'</span>,
  <span class="string">'11111111111111111110101101'</span>,
  <span class="string">'11111111111111111110101110'</span>,
  <span class="string">'11111111111111111110101111'</span>,
  <span class="string">'11111111111111111110110000'</span>,
  <span class="string">'11111111111111111110110001'</span>,
  <span class="string">'11111111111111111110110010'</span>,
  <span class="string">'11111111111111111110110011'</span>,
  <span class="string">'11111111111111111110110100'</span>,
  <span class="string">'11111111111111111110110101'</span>,
  <span class="string">'11111111111111111110110110'</span>,
  <span class="string">'11111111111111111110110111'</span>,
  <span class="string">'11111111111111111110111000'</span>,
  <span class="string">'11111111111111111110111001'</span>,
  <span class="string">'11111111111111111110111010'</span>,
  <span class="string">'11111111111111111110111011'</span>,
  <span class="string">'11111111111111111110111100'</span>,
  <span class="string">'11111111111111111110111101'</span>,
  <span class="string">'11111111111111111110111110'</span>,
  <span class="string">'11111111111111111110111111'</span>,
  <span class="string">'11111111111111111111000000'</span>,
  <span class="string">'11111111111111111111000001'</span>,
  <span class="string">'11111111111111111111000010'</span>,
  <span class="string">'11111111111111111111000011'</span>,
  <span class="string">'11111111111111111111000100'</span>,
  <span class="string">'11111111111111111111000101'</span>,
  <span class="string">'11111111111111111111000110'</span>,
  <span class="string">'11111111111111111111000111'</span>,
  <span class="string">'11111111111111111111001000'</span>,
  <span class="string">'11111111111111111111001001'</span>,
  <span class="string">'11111111111111111111001010'</span>,
  <span class="string">'11111111111111111111001011'</span>,
  <span class="string">'11111111111111111111001100'</span>,
  <span class="string">'11111111111111111111001101'</span>,
  <span class="string">'11111111111111111111001110'</span>,
  <span class="string">'11111111111111111111001111'</span>,
  <span class="string">'11111111111111111111010000'</span>,
  <span class="string">'11111111111111111111010001'</span>,
  <span class="string">'11111111111111111111010010'</span>,
  <span class="string">'11111111111111111111010011'</span>,
  <span class="string">'11111111111111111111010100'</span>,
  <span class="string">'11111111111111111111010101'</span>,
  <span class="string">'11111111111111111111010110'</span>,
  <span class="string">'11111111111111111111010111'</span>,
  <span class="string">'11111111111111111111011000'</span>,
  <span class="string">'11111111111111111111011001'</span>,
  <span class="string">'11111111111111111111011010'</span>,
  <span class="string">'11111111111111111111011011'</span>,
  <span class="string">'11111111111111111111011100'</span>
]);

HuffmanTable.responseHuffmanTable = <span class="keyword">new</span> HuffmanTable([
  <span class="string">'1111111111111111110111100'</span>,
  <span class="string">'1111111111111111110111101'</span>,
  <span class="string">'1111111111111111110111110'</span>,
  <span class="string">'1111111111111111110111111'</span>,
  <span class="string">'1111111111111111111000000'</span>,
  <span class="string">'1111111111111111111000001'</span>,
  <span class="string">'1111111111111111111000010'</span>,
  <span class="string">'1111111111111111111000011'</span>,
  <span class="string">'1111111111111111111000100'</span>,
  <span class="string">'1111111111111111111000101'</span>,
  <span class="string">'1111111111111111111000110'</span>,
  <span class="string">'1111111111111111111000111'</span>,
  <span class="string">'1111111111111111111001000'</span>,
  <span class="string">'1111111111111111111001001'</span>,
  <span class="string">'1111111111111111111001010'</span>,
  <span class="string">'1111111111111111111001011'</span>,
  <span class="string">'1111111111111111111001100'</span>,
  <span class="string">'1111111111111111111001101'</span>,
  <span class="string">'1111111111111111111001110'</span>,
  <span class="string">'1111111111111111111001111'</span>,
  <span class="string">'1111111111111111111010000'</span>,
  <span class="string">'1111111111111111111010001'</span>,
  <span class="string">'1111111111111111111010010'</span>,
  <span class="string">'1111111111111111111010011'</span>,
  <span class="string">'1111111111111111111010100'</span>,
  <span class="string">'1111111111111111111010101'</span>,
  <span class="string">'1111111111111111111010110'</span>,
  <span class="string">'1111111111111111111010111'</span>,
  <span class="string">'1111111111111111111011000'</span>,
  <span class="string">'1111111111111111111011001'</span>,
  <span class="string">'1111111111111111111011010'</span>,
  <span class="string">'1111111111111111111011011'</span>,
  <span class="string">'0000'</span>,
  <span class="string">'111111111010'</span>,
  <span class="string">'1101010'</span>,
  <span class="string">'1111111111010'</span>,
  <span class="string">'11111111111100'</span>,
  <span class="string">'111101100'</span>,
  <span class="string">'1111111000'</span>,
  <span class="string">'1111111111011'</span>,
  <span class="string">'111101101'</span>,
  <span class="string">'111101110'</span>,
  <span class="string">'111111111011'</span>,
  <span class="string">'11111111010'</span>,
  <span class="string">'100010'</span>,
  <span class="string">'100011'</span>,
  <span class="string">'100100'</span>,
  <span class="string">'1101011'</span>,
  <span class="string">'0001'</span>,
  <span class="string">'0010'</span>,
  <span class="string">'0011'</span>,
  <span class="string">'01000'</span>,
  <span class="string">'01001'</span>,
  <span class="string">'01010'</span>,
  <span class="string">'100101'</span>,
  <span class="string">'100110'</span>,
  <span class="string">'01011'</span>,
  <span class="string">'01100'</span>,
  <span class="string">'01101'</span>,
  <span class="string">'111101111'</span>,
  <span class="string">'1111111111111010'</span>,
  <span class="string">'1101100'</span>,
  <span class="string">'1111111111100'</span>,
  <span class="string">'111111111100'</span>,
  <span class="string">'1111111111111011'</span>,
  <span class="string">'1101101'</span>,
  <span class="string">'11101010'</span>,
  <span class="string">'11101011'</span>,
  <span class="string">'11101100'</span>,
  <span class="string">'11101101'</span>,
  <span class="string">'11101110'</span>,
  <span class="string">'100111'</span>,
  <span class="string">'111110000'</span>,
  <span class="string">'11101111'</span>,
  <span class="string">'11110000'</span>,
  <span class="string">'1111111001'</span>,
  <span class="string">'111110001'</span>,
  <span class="string">'101000'</span>,
  <span class="string">'11110001'</span>,
  <span class="string">'11110010'</span>,
  <span class="string">'111110010'</span>,
  <span class="string">'1111111010'</span>,
  <span class="string">'111110011'</span>,
  <span class="string">'101001'</span>,
  <span class="string">'01110'</span>,
  <span class="string">'111110100'</span>,
  <span class="string">'111110101'</span>,
  <span class="string">'11110011'</span>,
  <span class="string">'1111111011'</span>,
  <span class="string">'111110110'</span>,
  <span class="string">'1111111100'</span>,
  <span class="string">'11111111011'</span>,
  <span class="string">'1111111111101'</span>,
  <span class="string">'11111111100'</span>,
  <span class="string">'111111111111100'</span>,
  <span class="string">'111110111'</span>,
  <span class="string">'11111111111111110'</span>,
  <span class="string">'01111'</span>,
  <span class="string">'1101110'</span>,
  <span class="string">'101010'</span>,
  <span class="string">'101011'</span>,
  <span class="string">'10000'</span>,
  <span class="string">'1101111'</span>,
  <span class="string">'1110000'</span>,
  <span class="string">'1110001'</span>,
  <span class="string">'101100'</span>,
  <span class="string">'111111000'</span>,
  <span class="string">'111111001'</span>,
  <span class="string">'1110010'</span>,
  <span class="string">'101101'</span>,
  <span class="string">'101110'</span>,
  <span class="string">'101111'</span>,
  <span class="string">'110000'</span>,
  <span class="string">'111111010'</span>,
  <span class="string">'110001'</span>,
  <span class="string">'110010'</span>,
  <span class="string">'110011'</span>,
  <span class="string">'110100'</span>,
  <span class="string">'1110011'</span>,
  <span class="string">'11110100'</span>,
  <span class="string">'1110100'</span>,
  <span class="string">'11110101'</span>,
  <span class="string">'111111011'</span>,
  <span class="string">'1111111111111100'</span>,
  <span class="string">'11111111111101'</span>,
  <span class="string">'1111111111111101'</span>,
  <span class="string">'1111111111111110'</span>,
  <span class="string">'1111111111111111111011100'</span>,
  <span class="string">'1111111111111111111011101'</span>,
  <span class="string">'1111111111111111111011110'</span>,
  <span class="string">'1111111111111111111011111'</span>,
  <span class="string">'1111111111111111111100000'</span>,
  <span class="string">'1111111111111111111100001'</span>,
  <span class="string">'1111111111111111111100010'</span>,
  <span class="string">'1111111111111111111100011'</span>,
  <span class="string">'1111111111111111111100100'</span>,
  <span class="string">'1111111111111111111100101'</span>,
  <span class="string">'1111111111111111111100110'</span>,
  <span class="string">'1111111111111111111100111'</span>,
  <span class="string">'1111111111111111111101000'</span>,
  <span class="string">'1111111111111111111101001'</span>,
  <span class="string">'1111111111111111111101010'</span>,
  <span class="string">'1111111111111111111101011'</span>,
  <span class="string">'1111111111111111111101100'</span>,
  <span class="string">'1111111111111111111101101'</span>,
  <span class="string">'1111111111111111111101110'</span>,
  <span class="string">'1111111111111111111101111'</span>,
  <span class="string">'1111111111111111111110000'</span>,
  <span class="string">'1111111111111111111110001'</span>,
  <span class="string">'1111111111111111111110010'</span>,
  <span class="string">'1111111111111111111110011'</span>,
  <span class="string">'1111111111111111111110100'</span>,
  <span class="string">'1111111111111111111110101'</span>,
  <span class="string">'1111111111111111111110110'</span>,
  <span class="string">'1111111111111111111110111'</span>,
  <span class="string">'1111111111111111111111000'</span>,
  <span class="string">'1111111111111111111111001'</span>,
  <span class="string">'1111111111111111111111010'</span>,
  <span class="string">'1111111111111111111111011'</span>,
  <span class="string">'1111111111111111111111100'</span>,
  <span class="string">'1111111111111111111111101'</span>,
  <span class="string">'1111111111111111111111110'</span>,
  <span class="string">'1111111111111111111111111'</span>,
  <span class="string">'111111111111111110000000'</span>,
  <span class="string">'111111111111111110000001'</span>,
  <span class="string">'111111111111111110000010'</span>,
  <span class="string">'111111111111111110000011'</span>,
  <span class="string">'111111111111111110000100'</span>,
  <span class="string">'111111111111111110000101'</span>,
  <span class="string">'111111111111111110000110'</span>,
  <span class="string">'111111111111111110000111'</span>,
  <span class="string">'111111111111111110001000'</span>,
  <span class="string">'111111111111111110001001'</span>,
  <span class="string">'111111111111111110001010'</span>,
  <span class="string">'111111111111111110001011'</span>,
  <span class="string">'111111111111111110001100'</span>,
  <span class="string">'111111111111111110001101'</span>,
  <span class="string">'111111111111111110001110'</span>,
  <span class="string">'111111111111111110001111'</span>,
  <span class="string">'111111111111111110010000'</span>,
  <span class="string">'111111111111111110010001'</span>,
  <span class="string">'111111111111111110010010'</span>,
  <span class="string">'111111111111111110010011'</span>,
  <span class="string">'111111111111111110010100'</span>,
  <span class="string">'111111111111111110010101'</span>,
  <span class="string">'111111111111111110010110'</span>,
  <span class="string">'111111111111111110010111'</span>,
  <span class="string">'111111111111111110011000'</span>,
  <span class="string">'111111111111111110011001'</span>,
  <span class="string">'111111111111111110011010'</span>,
  <span class="string">'111111111111111110011011'</span>,
  <span class="string">'111111111111111110011100'</span>,
  <span class="string">'111111111111111110011101'</span>,
  <span class="string">'111111111111111110011110'</span>,
  <span class="string">'111111111111111110011111'</span>,
  <span class="string">'111111111111111110100000'</span>,
  <span class="string">'111111111111111110100001'</span>,
  <span class="string">'111111111111111110100010'</span>,
  <span class="string">'111111111111111110100011'</span>,
  <span class="string">'111111111111111110100100'</span>,
  <span class="string">'111111111111111110100101'</span>,
  <span class="string">'111111111111111110100110'</span>,
  <span class="string">'111111111111111110100111'</span>,
  <span class="string">'111111111111111110101000'</span>,
  <span class="string">'111111111111111110101001'</span>,
  <span class="string">'111111111111111110101010'</span>,
  <span class="string">'111111111111111110101011'</span>,
  <span class="string">'111111111111111110101100'</span>,
  <span class="string">'111111111111111110101101'</span>,
  <span class="string">'111111111111111110101110'</span>,
  <span class="string">'111111111111111110101111'</span>,
  <span class="string">'111111111111111110110000'</span>,
  <span class="string">'111111111111111110110001'</span>,
  <span class="string">'111111111111111110110010'</span>,
  <span class="string">'111111111111111110110011'</span>,
  <span class="string">'111111111111111110110100'</span>,
  <span class="string">'111111111111111110110101'</span>,
  <span class="string">'111111111111111110110110'</span>,
  <span class="string">'111111111111111110110111'</span>,
  <span class="string">'111111111111111110111000'</span>,
  <span class="string">'111111111111111110111001'</span>,
  <span class="string">'111111111111111110111010'</span>,
  <span class="string">'111111111111111110111011'</span>,
  <span class="string">'111111111111111110111100'</span>,
  <span class="string">'111111111111111110111101'</span>,
  <span class="string">'111111111111111110111110'</span>,
  <span class="string">'111111111111111110111111'</span>,
  <span class="string">'111111111111111111000000'</span>,
  <span class="string">'111111111111111111000001'</span>,
  <span class="string">'111111111111111111000010'</span>,
  <span class="string">'111111111111111111000011'</span>,
  <span class="string">'111111111111111111000100'</span>,
  <span class="string">'111111111111111111000101'</span>,
  <span class="string">'111111111111111111000110'</span>,
  <span class="string">'111111111111111111000111'</span>,
  <span class="string">'111111111111111111001000'</span>,
  <span class="string">'111111111111111111001001'</span>,
  <span class="string">'111111111111111111001010'</span>,
  <span class="string">'111111111111111111001011'</span>,
  <span class="string">'111111111111111111001100'</span>,
  <span class="string">'111111111111111111001101'</span>,
  <span class="string">'111111111111111111001110'</span>,
  <span class="string">'111111111111111111001111'</span>,
  <span class="string">'111111111111111111010000'</span>,
  <span class="string">'111111111111111111010001'</span>,
  <span class="string">'111111111111111111010010'</span>,
  <span class="string">'111111111111111111010011'</span>,
  <span class="string">'111111111111111111010100'</span>,
  <span class="string">'111111111111111111010101'</span>,
  <span class="string">'111111111111111111010110'</span>,
  <span class="string">'111111111111111111010111'</span>,
  <span class="string">'111111111111111111011000'</span>,
  <span class="string">'111111111111111111011001'</span>,
  <span class="string">'111111111111111111011010'</span>,
  <span class="string">'111111111111111111011011'</span>,
  <span class="string">'111111111111111111011100'</span>,
  <span class="string">'111111111111111111011101'</span>
]);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h3 id="string-literal-representation">String literal representation</h3>
<p>Literal <strong>strings</strong> can represent header names or header values. There&#39;s two variant of the
string encoding:</p>
<p>String literal with Huffman encoding:</p>
<pre><code>  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
| 1 |  Value Length Prefix (7)  |
+---+---+---+---+---+---+---+---+
|   Value Length (0-N bytes)    |
+---+---+---+---+---+---+---+---+
...
+---+---+---+---+---+---+---+---+
| Huffman Encoded Data  |Padding|
+---+---+---+---+---+---+---+---+</code></pre>
<p>String literal without Huffman encoding:</p>
<pre><code>  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
| 0 |  Value Length Prefix (7)  |
+---+---+---+---+---+---+---+---+
|   Value Length (0-N bytes)    |
+---+---+---+---+---+---+---+---+
...
+---+---+---+---+---+---+---+---+
|  Field Bytes Without Encoding |
+---+---+---+---+---+---+---+---+</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>HeaderSetCompressor.string = <span class="function"><span class="keyword">function</span> <span class="title">writeString</span><span class="params">(str, huffmanTable)</span> {</span>
  str = <span class="keyword">new</span> Buffer(str, <span class="string">'utf8'</span>);

  <span class="keyword">var</span> huffman = huffmanTable.encode(str);
  <span class="keyword">if</span> (huffman.length &lt; str.length) {
    <span class="keyword">var</span> length = HeaderSetCompressor.integer(huffman.length, <span class="number">7</span>)
    length[<span class="number">0</span>][<span class="number">0</span>] |= <span class="number">128</span>;
    <span class="keyword">return</span> length.concat(huffman);
  }

  <span class="keyword">else</span> {
    length = HeaderSetCompressor.integer(str.length, <span class="number">7</span>)
    <span class="keyword">return</span> length.concat(str);
  }
};

HeaderSetDecompressor.string = <span class="function"><span class="keyword">function</span> <span class="title">readString</span><span class="params">(buffer, huffmanTable)</span> {</span>
  <span class="keyword">var</span> huffman = buffer[buffer.cursor] &amp; <span class="number">128</span>;
  <span class="keyword">var</span> length = HeaderSetDecompressor.integer(buffer, <span class="number">7</span>);
  <span class="keyword">var</span> encoded = buffer.slice(buffer.cursor, buffer.cursor + length);
  buffer.cursor += length;
  <span class="keyword">return</span> (huffman ? huffmanTable.decode(encoded) : encoded).toString(<span class="string">'utf8'</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h3 id="header-represenations">Header represenations</h3>
<p>The JavaScript object representation is described near the
<code>HeaderSetDecompressor.prototype._execute()</code> method definition.</p>
<p><strong>All binary header representations</strong> start with a prefix signaling the representation type and
an index represented using prefix coded integers:</p>
<pre><code>  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
| 1 |        Index (7+)         |  Indexed Representation
+---+---------------------------+

  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
| 0 | 1 |      Index (6+)       |
+---+---+---+-------------------+  Literal w/o Indexing
|       Value Length (8+)       |
+-------------------------------+  w/ Indexed Name
| Value String (Length octets)  |
+-------------------------------+

  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
| 0 | 1 |           0           |
+---+---+---+-------------------+
|       Name Length (8+)        |
+-------------------------------+  Literal w/o Indexing
|  Name String (Length octets)  |
+-------------------------------+  w/ New Name
|       Value Length (8+)       |
+-------------------------------+
| Value String (Length octets)  |
+-------------------------------+

  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
| 0 | 0 |      Index (6+)       |
+---+---+---+-------------------+  Literal w/ Incremental Indexing
|       Value Length (8+)       |
+-------------------------------+  w/ Indexed Name
| Value String (Length octets)  |
+-------------------------------+

  0   1   2   3   4   5   6   7
+---+---+---+---+---+---+---+---+
| 0 | 0 |           0           |
+---+---+---+-------------------+
|       Name Length (8+)        |
+-------------------------------+  Literal w/ Incremental Indexing
|  Name String (Length octets)  |
+-------------------------------+  w/ New Name
|       Value Length (8+)       |
+-------------------------------+
| Value String (Length octets)  |
+-------------------------------+</code></pre>
<p>The <strong>Indexed Representation</strong> consists of the 1-bit prefix and the Index that is represented as
a 7-bit prefix coded integer and nothing else.</p>
<p>After the first bits, <strong>all literal representations</strong> specify the header name, either as a
pointer to the Header Table (Index) or a string literal. When the string literal representation
is used, the Index is set to 0 and the string literal starts at the second byte.</p>
<p>For <strong>all literal representations</strong>, the specification of the header value comes next. It is
always represented as a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> representations = {
  indexed             : { prefix: <span class="number">7</span>, pattern: <span class="number">0x80</span> },
  literal             : { prefix: <span class="number">6</span>, pattern: <span class="number">0x40</span> },
  literalIncremental  : { prefix: <span class="number">6</span>, pattern: <span class="number">0x00</span> }
};

HeaderSetCompressor.header = <span class="function"><span class="keyword">function</span> <span class="title">writeHeader</span><span class="params">(header, huffmanTable)</span> {</span>
  <span class="keyword">var</span> representation, buffers = [];

  <span class="keyword">if</span> (<span class="keyword">typeof</span> header.value === <span class="string">'number'</span>) {
    representation = representations.indexed;
  } <span class="keyword">else</span> <span class="keyword">if</span> (header.index) {
    representation = representations.literalIncremental;
  } <span class="keyword">else</span> {
    representation = representations.literal;
  }

  <span class="keyword">if</span> (representation === representations.indexed) {
    buffers.push(HeaderSetCompressor.integer(header.value + <span class="number">1</span>, representation.prefix));
  }

  <span class="keyword">else</span> {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> header.name === <span class="string">'number'</span>) {
      buffers.push(HeaderSetCompressor.integer(header.name + <span class="number">1</span>, representation.prefix));
    } <span class="keyword">else</span> {
      buffers.push(HeaderSetCompressor.integer(<span class="number">0</span>, representation.prefix));
      buffers.push(HeaderSetCompressor.string(header.name, huffmanTable));
    }
    buffers.push(HeaderSetCompressor.string(header.value, huffmanTable));
  }

  buffers[<span class="number">0</span>][<span class="number">0</span>][<span class="number">0</span>] |= representation.pattern;

  <span class="keyword">return</span> Array.prototype.concat.apply([], buffers); <span class="comment">// array of arrays of buffers -&gt; array of buffers</span>
};

HeaderSetDecompressor.header = <span class="function"><span class="keyword">function</span> <span class="title">readHeader</span><span class="params">(buffer, huffmanTable)</span> {</span>
  <span class="keyword">var</span> representation, header = {};

  <span class="keyword">var</span> firstByte = buffer[buffer.cursor];
  <span class="keyword">if</span> (firstByte &amp; <span class="number">0x80</span>) {
    representation = representations.indexed;
  } <span class="keyword">else</span> <span class="keyword">if</span> (firstByte &amp; <span class="number">0x40</span>) {
    representation = representations.literal;
  } <span class="keyword">else</span> {
    representation = representations.literalIncremental;
  }

  <span class="keyword">if</span> (representation === representations.indexed) {
    header.value = header.name = HeaderSetDecompressor.integer(buffer, representation.prefix) - <span class="number">1</span>;
    header.index = <span class="literal">false</span>;
  }

  <span class="keyword">else</span> {
    header.name = HeaderSetDecompressor.integer(buffer, representation.prefix) - <span class="number">1</span>;
    <span class="keyword">if</span> (header.name === -<span class="number">1</span>) {
      header.name = HeaderSetDecompressor.string(buffer, huffmanTable);
    }
    header.value = HeaderSetDecompressor.string(buffer, huffmanTable);
    header.index = (representation === representations.literalIncremental);
  }

  <span class="keyword">return</span> header;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h1 id="integration-with-http-2">Integration with HTTP/2</h1>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>This section describes the interaction between the compressor/decompressor and the rest of the
HTTP/2 implementation. The <code>Compressor</code> and the <code>Decompressor</code> makes up a layer between the
<a href="framer.html">framer</a> and the <a href="connection.html">connection handling component</a>. They let most
frames pass through, except HEADERS and PUSH_PROMISE frames. They convert the frames between
these two representations:</p>
<pre><code>{                                   {
 type: &#39;HEADERS&#39;,                    type: &#39;HEADERS&#39;,
 flags: {},                          flags: {},
 stream: 1,               &lt;===&gt;      stream: 1,
 headers: {                          data: Buffer
  N1: &#39;V1&#39;,                         }
  N2: [&#39;V1&#39;, &#39;V2&#39;, ...],
  // ...
 }
}</code></pre>
<p>There are possibly several binary frame that belong to a single non-binary frame.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> MAX_HTTP_PAYLOAD_SIZE = <span class="number">16383</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="the-compressor-class">The Compressor class</h2>

            </div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>The Compressor transform stream is basically stateless.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>util.inherits(Compressor, TransformStream);
<span class="function"><span class="keyword">function</span> <span class="title">Compressor</span><span class="params">(log, type)</span> {</span>
  TransformStream.call(<span class="keyword">this</span>, { objectMode: <span class="literal">true</span> });

  <span class="keyword">this</span>._log = log.child({ component: <span class="string">'compressor'</span> });

  assert((type === <span class="string">'REQUEST'</span>) || (type === <span class="string">'RESPONSE'</span>));
  <span class="keyword">this</span>._huffmanTable = (type === <span class="string">'REQUEST'</span>) ? HuffmanTable.requestHuffmanTable
                                            : HuffmanTable.responseHuffmanTable;
  <span class="keyword">this</span>._table = <span class="keyword">new</span> HeaderTable(<span class="keyword">this</span>._log);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Changing the header table size</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Compressor.prototype.setTableSizeLimit = <span class="function"><span class="keyword">function</span> <span class="title">setTableSizeLimit</span><span class="params">(size)</span> {</span>
  <span class="keyword">this</span>._table.setSizeLimit(size);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><code>compress</code> takes a header set, and compresses it using a new <code>HeaderSetCompressor</code> stream
instance. This means that from now on, the advantages of streaming header encoding are lost,
but the API becomes simpler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Compressor.prototype.compress = <span class="function"><span class="keyword">function</span> <span class="title">compress</span><span class="params">(headers)</span> {</span>
  <span class="keyword">var</span> compressor = <span class="keyword">new</span> HeaderSetCompressor(<span class="keyword">this</span>._log, <span class="keyword">this</span>._table, <span class="keyword">this</span>._huffmanTable);
  <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> headers) {
    <span class="keyword">var</span> value = headers[name];
    name = String(name).toLowerCase();</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <ul>
<li>To allow for better compression efficiency, the Cookie header field MAY be split into
separate header fields, each with one or more cookie-pairs.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (name == <span class="string">'cookie'</span>) {
      <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> Array)) {
        value = [value]
      }
      value = Array.prototype.concat.apply([], value.map(<span class="function"><span class="keyword">function</span><span class="params">(cookie)</span> {</span>
        <span class="keyword">return</span> String(cookie).split(<span class="string">';'</span>).map(trim)
      }));
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <ul>
<li>To preserve the order of a comma-separated list, the ordered values for a single header
field name appearing in different header fields are concatenated into a single value.
A zero-valued octet (0x0) is used to delimit multiple values.</li>
<li>Header fields containing multiple values MUST be concatenated into a single value unless
the ordering of that header field is known to be not significant.</li>
<li>Currently, only the Cookie header is considered to be order-insensitive.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> ((value <span class="keyword">instanceof</span> Array) &amp;&amp; (name !== <span class="string">'cookie'</span>)) {
      value = value.join(<span class="string">'\0'</span>);
    }

    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Array) {
      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; value.length; i++) {
        compressor.write([name, String(value[i])]);
      }
    } <span class="keyword">else</span> {
      compressor.write([name, String(value)]);
    }
  }
  compressor.end();

  <span class="keyword">var</span> chunk, chunks = [];
  <span class="keyword">while</span> (chunk = compressor.read()) {
    chunks.push(chunk);
  }
  <span class="keyword">return</span> concat(chunks);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>When a <code>frame</code> arrives</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Compressor.prototype._transform = <span class="function"><span class="keyword">function</span> <span class="title">_transform</span><span class="params">(frame, encoding, done)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <ul>
<li>and it is a HEADERS or PUSH_PROMISE frame<ul>
<li>it generates a header block using the compress method</li>
<li>cuts the header block into <code>chunks</code> that are not larger than <code>MAX_HTTP_PAYLOAD_SIZE</code></li>
<li>for each chunk, it pushes out a chunk frame that is identical to the original, except
the <code>data</code> property which holds the given chunk, the type of the frame which is always
CONTINUATION except for the first frame, and the END_HEADERS/END_PUSH_STREAM flag that
marks the last frame and the END_STREAM flag which is always false before the end</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (frame.type === <span class="string">'HEADERS'</span> || frame.type === <span class="string">'PUSH_PROMISE'</span>) {
    <span class="keyword">var</span> buffer = <span class="keyword">this</span>.compress(frame.headers);

    <span class="keyword">var</span> chunks = cut(buffer, MAX_HTTP_PAYLOAD_SIZE);

    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; chunks.length; i++) {
      <span class="keyword">var</span> chunkFrame;
      <span class="keyword">var</span> first = (i === <span class="number">0</span>);
      <span class="keyword">var</span> last = (i === chunks.length - <span class="number">1</span>);

      <span class="keyword">if</span> (first) {
        chunkFrame = util._extend({}, frame);
        chunkFrame.flags = util._extend({}, frame.flags);
        chunkFrame.flags[<span class="string">'END_'</span> + frame.type] = last;
      } <span class="keyword">else</span> {
        chunkFrame = {
          type: <span class="string">'CONTINUATION'</span>,
          flags: { END_HEADERS: last },
          stream: frame.stream
        };
      }
      chunkFrame.data = chunks[i];

      <span class="keyword">this</span>.push(chunkFrame);
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <ul>
<li>otherwise, the frame is forwarded without taking any action</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">else</span> {
    <span class="keyword">this</span>.push(frame);
  }

  done();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h2 id="the-decompressor-class">The Decompressor class</h2>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>The Decompressor is a stateful transform stream, since it has to collect multiple frames first,
and the decoding comes after unifying the payload of those frames.</p>
<p>If there&#39;s a frame in progress, <code>this._inProgress</code> is <code>true</code>. The frames are collected in
<code>this._frames</code>, and the type of the frame and the stream identifier is stored in <code>this._type</code>
and <code>this._stream</code> respectively.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>util.inherits(Decompressor, TransformStream);
<span class="function"><span class="keyword">function</span> <span class="title">Decompressor</span><span class="params">(log, type)</span> {</span>
  TransformStream.call(<span class="keyword">this</span>, { objectMode: <span class="literal">true</span> });

  <span class="keyword">this</span>._log = log.child({ component: <span class="string">'compressor'</span> });

  assert((type === <span class="string">'REQUEST'</span>) || (type === <span class="string">'RESPONSE'</span>));
  <span class="keyword">this</span>._huffmanTable = (type === <span class="string">'REQUEST'</span>) ? HuffmanTable.requestHuffmanTable
                                            : HuffmanTable.responseHuffmanTable;
  <span class="keyword">this</span>._table = <span class="keyword">new</span> HeaderTable(<span class="keyword">this</span>._log);

  <span class="keyword">this</span>._inProgress = <span class="literal">false</span>;
  <span class="keyword">this</span>._base = <span class="literal">undefined</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Changing the header table size</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Decompressor.prototype.setTableSizeLimit = <span class="function"><span class="keyword">function</span> <span class="title">setTableSizeLimit</span><span class="params">(size)</span> {</span>
  <span class="keyword">this</span>._table.setSizeLimit(size);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><code>decompress</code> takes a full header block, and decompresses it using a new <code>HeaderSetDecompressor</code>
stream instance. This means that from now on, the advantages of streaming header decoding are
lost, but the API becomes simpler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Decompressor.prototype.decompress = <span class="function"><span class="keyword">function</span> <span class="title">decompress</span><span class="params">(block)</span> {</span>
  <span class="keyword">var</span> decompressor = <span class="keyword">new</span> HeaderSetDecompressor(<span class="keyword">this</span>._log, <span class="keyword">this</span>._table, <span class="keyword">this</span>._huffmanTable);
  decompressor.end(block);

  <span class="keyword">var</span> headers = {};
  <span class="keyword">var</span> pair;
  <span class="keyword">while</span> (pair = decompressor.read()) {
    <span class="keyword">var</span> name = pair[<span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <ul>
<li>After decompression, header fields that have values containing zero octets (0x0) MUST be
split into multiple header fields before being processed.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> values = pair[<span class="number">1</span>].split(<span class="string">'\0'</span>);
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; values.length; i++) {
      <span class="keyword">var</span> value = values[i];
      <span class="keyword">if</span> (name <span class="keyword">in</span> headers) {
        <span class="keyword">if</span> (headers[name] <span class="keyword">instanceof</span> Array) {
          headers[name].push(value);
        } <span class="keyword">else</span> {
          headers[name] = [headers[name], value];
        }
      } <span class="keyword">else</span> {
        headers[name] = value;
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <ul>
<li>If there are multiple Cookie header fields after decompression, these MUST be concatenated
into a single octet string using the two octet delimiter of 0x3B, 0x20 (the ASCII
string &quot;; &quot;).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> ((<span class="string">'cookie'</span> <span class="keyword">in</span> headers) &amp;&amp; (headers[<span class="string">'cookie'</span>] <span class="keyword">instanceof</span> Array)) {
    headers[<span class="string">'cookie'</span>] = headers[<span class="string">'cookie'</span>].join(<span class="string">'; '</span>)
  }

  <span class="keyword">return</span> headers;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>When a <code>frame</code> arrives</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Decompressor.prototype._transform = <span class="function"><span class="keyword">function</span> <span class="title">_transform</span><span class="params">(frame, encoding, done)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <ul>
<li>and the collection process is already <code>_inProgress</code>, the frame is simply stored, except if
it&#39;s an illegal frame</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (<span class="keyword">this</span>._inProgress) {
    <span class="keyword">if</span> ((frame.type !== <span class="string">'CONTINUATION'</span>) || (frame.stream !== <span class="keyword">this</span>._base.stream)) {
      <span class="keyword">this</span>._log.error(<span class="string">'A series of HEADER frames were not continuous'</span>);
      <span class="keyword">this</span>.emit(<span class="string">'error'</span>, <span class="string">'PROTOCOL_ERROR'</span>);
      <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>._frames.push(frame);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <ul>
<li>and the collection process is not <code>_inProgress</code>, but the new frame&#39;s type is HEADERS or
PUSH_PROMISE, a new collection process begins</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">else</span> <span class="keyword">if</span> ((frame.type === <span class="string">'HEADERS'</span>) || (frame.type === <span class="string">'PUSH_PROMISE'</span>)) {
    <span class="keyword">this</span>._inProgress = <span class="literal">true</span>;
    <span class="keyword">this</span>._base = util._extend({}, frame);
    <span class="keyword">this</span>._frames = [frame];
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <ul>
<li>otherwise, the frame is forwarded without taking any action</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">else</span> {
    <span class="keyword">this</span>.push(frame);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <ul>
<li>When the frame signals that it&#39;s the last in the series, the header block chunks are
concatenated, the headers are decompressed, and a new frame gets pushed out with the
decompressed headers.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (<span class="keyword">this</span>._inProgress &amp;&amp; (frame.flags.END_HEADERS || frame.flags.END_PUSH_PROMISE)) {
    <span class="keyword">var</span> buffer = concat(<span class="keyword">this</span>._frames.map(<span class="function"><span class="keyword">function</span><span class="params">(frame)</span> {</span>
      <span class="keyword">return</span> frame.data;
    }));
    <span class="keyword">try</span> {
      <span class="keyword">var</span> headers = <span class="keyword">this</span>.decompress(buffer);
    } <span class="keyword">catch</span>(error) {
      <span class="keyword">this</span>._log.error({ err: error }, <span class="string">'Header decompression error'</span>);
      <span class="keyword">this</span>.emit(<span class="string">'error'</span>, <span class="string">'COMPRESSION_ERROR'</span>);
      <span class="keyword">return</span>;
    }
    <span class="keyword">this</span>.push(util._extend(<span class="keyword">this</span>._base, { headers: headers }));
    <span class="keyword">this</span>._inProgress = <span class="literal">false</span>;
  }

  done();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <h1 id="helper-functions">Helper functions</h1>

            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Concatenate an array of buffers into a new buffer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">concat</span><span class="params">(buffers)</span> {</span>
  <span class="keyword">var</span> size = <span class="number">0</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; buffers.length; i++) {
    size += buffers[i].length;
  }

  <span class="keyword">var</span> concatenated = <span class="keyword">new</span> Buffer(size);
  <span class="keyword">for</span> (<span class="keyword">var</span> cursor = <span class="number">0</span>, j = <span class="number">0</span>; j &lt; buffers.length; cursor += buffers[j].length, j++) {
    buffers[j].copy(concatenated, cursor);
  }

  <span class="keyword">return</span> concatenated;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Cut <code>buffer</code> into chunks not larger than <code>size</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="keyword">function</span> <span class="title">cut</span><span class="params">(buffer, size)</span> {</span>
  <span class="keyword">var</span> chunks = [];
  <span class="keyword">var</span> cursor = <span class="number">0</span>;
  <span class="keyword">do</span> {
    <span class="keyword">var</span> chunkSize = Math.min(size, buffer.length - cursor);
    chunks.push(buffer.slice(cursor, cursor + chunkSize));
    cursor += chunkSize;
  } <span class="keyword">while</span>(cursor &lt; buffer.length);
  <span class="keyword">return</span> chunks;
}

<span class="function"><span class="keyword">function</span> <span class="title">trim</span><span class="params">(string)</span> {</span>
  <span class="keyword">return</span> string.trim()
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
